import{_ as We,r as u,w as be,o as Fe,a as He,c as x,b as g,F as Z,d as Q,e as S,f as he,g as R,h as N,i as F,t as re,j as E,n as B,k as m,u as ve,p as je,m as qe,l as Ge,q as Ze}from"./index-BGTdQpH3.js";const Qe=""+new URL("a-4D4jeJx1.png",import.meta.url).href,Ne={class:"node-palette"},et=["onDragstart"],tt={class:"scale-control"},at={style:{width:"50px","text-align":"center"}},lt=["width","height"],nt=["d","stroke-width","stroke","onClick"],ot=["d"],it=["onMousedown","onClick"],st={style:{position:"absolute",top:"-30px"}},ut={key:0,class:"selection-box"},ct=["onMousedown"],rt=["onMousedown"],ht=["onMousedown"],vt=["onMousedown"],dt={class:"config-panel"},pt={key:1},mt={__name:"CflowEditorLoader",props:{bg:"",isConnectionType:!1,nodeTypes:[]},setup(H){const j=H,de=u(j.nodeTypes),f=u([]),z=u([]),r=u([]),w=u(""),I=u("curve"),O=u([]),ee=u({x:0,y:0}),V=u({}),p=u(1),d=u({x:0,y:0}),b=u({width:1920,height:1080}),T=u(!1),te=u({x:0,y:0}),L=u(!1),X=u(!1),h=u({show:!1,x:0,y:0,width:0,height:0}),M=u(!1),$=u({x:0,y:0}),v=u({width:0,height:0}),ae=u(""),J=u(null),K=u(null),A=u(null),y=u(!1),D=u(""),k=u({x:0,y:0}),U=u([]),C=u(8),Y=u(!0),_=(e,t)=>{const i=K.value.getBoundingClientRect();return{x:(e-i.left-d.value.x)/p.value,y:(t-i.top-d.value.y)/p.value}},Me=(e,t)=>{e.dataTransfer.setData("text/plain",JSON.stringify(t)),e.dataTransfer.effectAllowed="copy"},$e=(e,t)=>{if(e.button===2||L.value||X.value||M.value||y.value)return;!e.ctrlKey&&!e.shiftKey&&!r.value.includes(t.id)?r.value=[t.id]:(e.ctrlKey||e.shiftKey)&&!r.value.includes(t.id)&&r.value.push(t.id),O.value=[...r.value],V.value={},r.value.forEach(l=>{const a=f.value.find(s=>s.id===l);a&&(V.value[l]={x:a.x,y:a.y})});const i=_(e.clientX,e.clientY);ee.value={x:i.x,y:i.y},document.addEventListener("mousemove",le),document.addEventListener("mouseup",ne)},pe=e=>{const t=[],i=f.value.filter(l=>!e.some(a=>a.id===l.id));return e.forEach(l=>{const a={left:l.x,right:l.x+l.width,top:l.y,bottom:l.y+l.height,centerX:l.x+l.width/2,centerY:l.y+l.height/2};Math.abs(a.centerX-b.value.width/2)<=C.value&&(t.push({id:`guide-v-canvas-center-${l.id}`,left:b.value.width/2,top:0,width:2,height:b.value.height,color:"rgba(255, 0, 255, 0.7)"}),Y.value&&(l.x=b.value.width/2-l.width/2)),Math.abs(a.centerY-b.value.height/2)<=C.value&&(t.push({id:`guide-h-canvas-center-${l.id}`,left:0,top:b.value.height/2,width:b.value.width,height:2,color:"rgba(255, 0, 255, 0.7)"}),Y.value&&(l.y=b.value.height/2-l.height/2)),i.forEach(s=>{const n={left:s.x,right:s.x+s.width,top:s.y,bottom:s.y+s.height,centerX:s.x+s.width/2,centerY:s.y+s.height/2};[{condition:Math.abs(a.top-n.top)<=C.value,guide:{id:`guide-h-top-${l.id}-${s.id}`,left:Math.min(a.left,n.left),top:n.top,width:Math.max(a.right,n.right)-Math.min(a.left,n.left),height:2,color:"rgba(0, 200, 0, 0.7)"},snap:()=>{l.y=n.top}},{condition:Math.abs(a.bottom-n.bottom)<=C.value,guide:{id:`guide-h-bottom-${l.id}-${s.id}`,left:Math.min(a.left,n.left),top:n.bottom,width:Math.max(a.right,n.right)-Math.min(a.left,n.left),height:2,color:"rgba(0, 200, 0, 0.7)"},snap:()=>{l.y=n.bottom-l.height}},{condition:Math.abs(a.centerY-n.centerY)<=C.value,guide:{id:`guide-h-center-${l.id}-${s.id}`,left:Math.min(a.left,n.left),top:n.centerY,width:Math.max(a.right,n.right)-Math.min(a.left,n.left),height:2,color:"rgba(255, 0, 0, 0.7)"},snap:()=>{l.y=n.centerY-l.height/2}},{condition:Math.abs(a.left-n.left)<=C.value,guide:{id:`guide-v-left-${l.id}-${s.id}`,left:n.left,top:Math.min(a.top,n.top),height:Math.max(a.bottom,n.bottom)-Math.min(a.top,n.top),width:2,color:"rgba(0, 200, 0, 0.7)"},snap:()=>{l.x=n.left}},{condition:Math.abs(a.right-n.right)<=C.value,guide:{id:`guide-v-right-${l.id}-${s.id}`,left:n.right,top:Math.min(a.top,n.top),height:Math.max(a.bottom,n.bottom)-Math.min(a.top,n.top),width:2,color:"rgba(0, 200, 0, 0.7)"},snap:()=>{l.x=n.right-l.width}},{condition:Math.abs(a.centerX-n.centerX)<=C.value,guide:{id:`guide-v-center-${l.id}-${s.id}`,left:n.centerX,top:Math.min(a.top,n.top),height:Math.max(a.bottom,n.bottom)-Math.min(a.top,n.top),width:2,color:"rgba(255, 0, 0, 0.7)"},snap:()=>{l.x=n.centerX-l.width/2}},{condition:Math.abs(a.top-n.bottom)<=C.value,guide:{id:`guide-h-top-bottom-${l.id}-${s.id}`,left:Math.min(a.left,n.left),top:n.bottom,width:Math.max(a.right,n.right)-Math.min(a.left,n.left),height:2,color:"rgba(0, 150, 255, 0.7)"},snap:()=>{l.y=n.bottom}},{condition:Math.abs(a.bottom-n.top)<=C.value,guide:{id:`guide-h-bottom-top-${l.id}-${s.id}`,left:Math.min(a.left,n.left),top:n.top,width:Math.max(a.right,n.right)-Math.min(a.left,n.left),height:2,color:"rgba(0, 150, 255, 0.7)"},snap:()=>{l.y=n.top-l.height}}].forEach(c=>{c.condition&&(t.push(c.guide),Y.value&&c.snap())})})}),t},le=e=>{if(O.value.length===0)return;const t=_(e.clientX,e.clientY),i=t.x-ee.value.x,l=t.y-ee.value.y,a=[];O.value.forEach(n=>{const o=f.value.find(c=>c.id===n);o&&V.value[n]&&(o._tempX=V.value[n].x+i,o._tempY=V.value[n].y+l,a.push(o))}),a.forEach(n=>{n.x=n._tempX,n.y=n._tempY});let s=[];Y.value&&(s=pe(a)),U.value=s},ne=()=>{O.value=[],U.value=[],document.removeEventListener("mousemove",le),document.removeEventListener("mouseup",ne)},_e=e=>{e.preventDefault();const t=e.dataTransfer.getData("text/plain");if(t)try{const i=JSON.parse(t),l=_(e.clientX,e.clientY),a={id:`node-${Date.now()}`,...i,x:l.x-i.width/2,y:l.y-i.height/2,obj:{}};f.value.push(a),q.value=a,r.value=[a.id]}catch(i){console.error("放置节点失败:",i)}},q=u({}),ke=(e,t)=>{w.value="",!(L.value||X.value||M.value||y.value)&&(q.value=t,e.ctrlKey||e.shiftKey?r.value.includes(t.id)||r.value.push(t.id):r.value=[t.id])},G=(e,t,i)=>{if(r.value.length!==1||y.value)return;M.value=!0,ae.value=i;const l=_(e.clientX,e.clientY);$.value={x:l.x,y:l.y},v.value={width:t.width,height:t.height},document.addEventListener("mousemove",oe),document.addEventListener("mouseup",ie),e.stopPropagation()},oe=e=>{if(!M.value)return;const t=_(e.clientX,e.clientY),i=t.x-$.value.x,l=t.y-$.value.y,a=f.value.find(n=>n.id===r.value[0]);if(!a)return;const s=v.value.width/v.value.height;switch(ae.value){case"se":if(e.ctrlKey){const n=Math.max(20,v.value.width+i),o=n/s;a.width=n,a.height=o}else a.width=Math.max(20,v.value.width+i),a.height=Math.max(20,v.value.height+l);break;case"sw":if(e.ctrlKey){const n=Math.max(20,v.value.width-i),o=n/s;a.width=n,a.height=o,a.x=$.value.x-(a.width-v.value.width)}else a.width=Math.max(20,v.value.width-i),a.height=Math.max(20,v.value.height+l),a.x=$.value.x-(a.width-v.value.width);break;case"ne":if(e.ctrlKey){const n=Math.max(20,v.value.width+i),o=n/s;a.width=n,a.height=o,a.y=$.value.y-(a.height-v.value.height)}else a.width=Math.max(20,v.value.width+i),a.height=Math.max(20,v.value.height-l),a.y=$.value.y-(a.height-v.value.height);break;case"nw":if(e.ctrlKey){const n=Math.max(20,v.value.width-i),o=n/s;a.width=n,a.height=o,a.x=$.value.x-(a.width-v.value.width),a.y=$.value.y-(a.height-v.value.height)}else a.width=Math.max(20,v.value.width-i),a.height=Math.max(20,v.value.height-l),a.x=$.value.x-(a.width-v.value.width),a.y=$.value.y-(a.height-v.value.height);break}if(Y.value&&a){const n=pe([a]);U.value=n}},ie=()=>{M.value=!1,ae.value="",U.value=[],document.removeEventListener("mousemove",oe),document.removeEventListener("mouseup",ie)},Ce=e=>{if(w.value="",L.value||e.target!==A.value||M.value||y.value)return;X.value=!0;const t=_(e.clientX,e.clientY);h.value={show:!0,x:t.x,y:t.y,width:0,height:0},document.addEventListener("mousemove",se),document.addEventListener("mouseup",ue)},P=u({}),se=e=>{if(!X.value)return;const t=_(e.clientX,e.clientY);P.value={show:!0,x:t.x<h.value.x?t.x:h.value.x,y:t.y<h.value.y?t.y:h.value.y,width:Math.abs(t.x-h.value.x),height:Math.abs(t.y-h.value.y)},h.value={show:!0,x:h.value.x,y:h.value.y,width:t.x-h.value.x,height:t.y-h.value.y};const i=Math.min(h.value.x,h.value.x+h.value.width),l=Math.min(h.value.y,h.value.y+h.value.height),a=Math.max(h.value.x,h.value.x+h.value.width),s=Math.max(h.value.y,h.value.y+h.value.height),n=[];f.value.forEach(o=>{const c=o.x,Je=o.y,Ae=o.x+o.width,Ue=o.y+o.height;Ae>i&&c<a&&Ue>l&&Je<s&&n.push(o.id)}),r.value=n},ue=()=>{X.value=!1,h.value.show=!1,P.value={},document.removeEventListener("mousemove",se),document.removeEventListener("mouseup",ue)},Ee=e=>{if(e.target===A.value&&(w.value=""),y.value){y.value=!1,D.value="";return}e.target===A.value&&e.ctrlKey&&!L.value&&!M.value?Ce(e):e.target===A.value&&!L.value&&!X.value&&!e.ctrlKey&&!M.value&&(r.value=[])},me=()=>{if(r.value.length===0)return;const e=f.value.find(t=>t.id===r.value[0]);e&&(J.value=JSON.parse(JSON.stringify(e)))},fe=()=>{if(!J.value)return;const e={...JSON.parse(JSON.stringify(J.value)),id:`node-${Date.now()}`,x:J.value.x+20,y:J.value.y+20};f.value.push(e),r.value=[e.id]},Le=()=>{r.value.length!==0&&(f.value=f.value.filter(e=>!r.value.includes(e.id)),z.value=z.value.filter(e=>!r.value.includes(e.source)&&!r.value.includes(e.target)),r.value=[])},ye=()=>{w.value&&(z.value=z.value.filter(e=>e.id!==w.value),w.value="")},Xe=e=>{e.preventDefault();const t=K.value.getBoundingClientRect(),i=e.clientX-t.left,l=e.clientY-t.top,a=(i-d.value.x)/p.value,s=(l-d.value.y)/p.value,o=-e.deltaY>0?1.1:.9,c=Math.max(.1,Math.min(5,p.value*o));d.value.x=i-a*c,d.value.y=l-s*c,p.value=c},De=e=>{L.value&&e.button===0&&!M.value&&!y.value&&(T.value=!0,te.value={x:e.clientX-d.value.x,y:e.clientY-d.value.y},e.preventDefault())},Ye=e=>{if(T.value)d.value.x=e.clientX-te.value.x,d.value.y=e.clientY-te.value.y;else if(y.value){const t=_(e.clientX,e.clientY);k.value=t}},xe=()=>{T.value=!1},ge=e=>{if(e.key==="Delete"&&w.value){ye(),e.preventDefault();return}if(e.code==="Space"&&(L.value=!0,e.preventDefault()),e.key==="Alt"&&(Y.value=!1),e.ctrlKey||e.metaKey)switch(e.key.toLowerCase()){case"c":me(),e.preventDefault();break;case"v":fe(),e.preventDefault();break;case"d":me(),fe(),e.preventDefault();break}if(e.key==="Backspace"){const t=document.activeElement;t.tagName==="INPUT"||t.tagName==="TEXTAREA"||(Le(),e.preventDefault())}},we=e=>{e.code==="Space"&&(L.value=!1,T.value=!1),e.key==="Alt"&&(Y.value=!0)},Se=()=>{const e=K.value.getBoundingClientRect(),t=e.width/2,i=e.height/2,l=(t-d.value.x)/p.value,a=(i-d.value.y)/p.value,s=Math.min(5,p.value+.1);d.value.x=t-l*s,d.value.y=i-a*s,p.value=s},ze=()=>{const e=K.value.getBoundingClientRect(),t=e.width/2,i=e.height/2,l=(t-d.value.x)/p.value,a=(i-d.value.y)/p.value,s=Math.max(.1,p.value-.1);d.value.x=t-l*s,d.value.y=i-a*s,p.value=s},Te=()=>{p.value=1,d.value={x:0,y:0}},Ke=e=>{if(!j.isConnectionType)return;X.value=!1,M.value=!1,T.value=!1,w.value="",y.value=!0,D.value=e.id,K.value.getBoundingClientRect();const t=_(event.clientX,event.clientY);k.value=t,document.addEventListener("mousemove",ce)},ce=e=>{if(!y.value)return;const t=_(e.clientX,e.clientY);k.value=t},Pe=e=>{if(!y.value)return;document.removeEventListener("mousemove",ce);const t=_(e.clientX,e.clientY),i=f.value.find(l=>t.x>=l.x&&t.x<=l.x+l.width&&t.y>=l.y&&t.y<=l.y+l.height&&l.id!==D.value);i&&z.value.push({id:`conn-${Date.now()}`,source:D.value,target:i.id}),y.value=!1,D.value=""},W=e=>{const t=f.value.find(i=>i.id===e);return t?{x:t.x+t.width/2,y:t.y+t.height/2}:{x:0,y:0}},Re=e=>I.value==="mindmap"?Ie(e):Be(e),Be=e=>{const t=W(e.source),i=W(e.target),l=(t.x+i.x)/2;return`M ${t.x} ${t.y}
          C ${l} ${t.y},
            ${l} ${i.y},
            ${i.x} ${i.y}`},Ie=e=>{const t=W(e.source),i=W(e.target),l=50,a=t.x+l;return i.x>a&&i.x-l,`M ${t.x} ${t.y}
          L ${a} ${t.y}
          L ${a} ${i.y}
          L ${i.x} ${i.y}`},Oe=()=>{const e=W(D.value);if(I.value==="mindmap"){const i=e.x+50;return`M ${e.x} ${e.y}
            L ${i} ${e.y}
            L ${i} ${k.value.y}
            L ${k.value.x} ${k.value.y}`}else{const t=(e.x+k.value.x)/2;return`M ${e.x} ${e.y}
            C ${t} ${e.y},
              ${t} ${k.value.y},
              ${k.value.x} ${k.value.y}`}},Ve=e=>{r.value=[],w.value=e};return be(f,()=>{},{deep:!0}),be(I,()=>{}),Fe(()=>{document.querySelector(".flow-editor").focus()}),He(()=>{document.removeEventListener("mousemove",le),document.removeEventListener("mouseup",ne),document.removeEventListener("mousemove",se),document.removeEventListener("mouseup",ue),document.removeEventListener("mousemove",oe),document.removeEventListener("mouseup",ie),document.removeEventListener("keydown",ge),document.removeEventListener("keyup",we),document.removeEventListener("mousemove",ce)}),(e,t)=>{const i=F("el-icon"),l=F("el-option"),a=F("el-select"),s=F("el-input"),n=F("el-button");return m(),x("div",{class:"flow-editor",onWheel:Xe,onKeydown:ge,onKeyup:we,onMousedown:De,onMousemove:Ye,onMouseup:xe,onMouseleave:xe,tabindex:"0"},[g("div",Ne,[(m(!0),x(Z,null,Q(de.value,o=>(m(),x("div",{style:B({width:o.width+"px",height:o.height+"px",backgroundColor:o.color,borderRadius:o.type==="start"?"50%":"4px"}),key:o.type,class:"palette-node",draggable:"true",onDragstart:c=>Me(c,o)},re(o.label),45,et))),128))]),g("div",{class:"flow-canvas-container",ref_key:"canvasContainer",ref:K,style:B({cursor:T.value?"grabbing":L.value?"grab":X.value||y.value?"crosshair":"default"})},[g("div",tt,[S(i,{onClick:Se},{default:N(()=>[S(ve(je))]),_:1}),g("div",at,re(Math.round(p.value*100))+"%",1),S(i,{onClick:ze},{default:N(()=>[S(ve(qe))]),_:1}),g("span",{onClick:Te},"重置"),H.isConnectionType?(m(),he(a,{key:0,modelValue:I.value,"onUpdate:modelValue":t[0]||(t[0]=o=>I.value=o),style:{width:"120px","margin-left":"10px"},placeholder:"连线方式"},{default:N(()=>[S(l,{label:"曲线",value:"curve"}),S(l,{label:"脑图折线",value:"mindmap"})]),_:1},8,["modelValue"])):R("",!0)]),g("div",{class:"flow-canvas",ref_key:"canvas",ref:A,style:B({backgroundImage:`url(${H.bg})`,transform:`translate(${d.value.x}px, ${d.value.y}px) scale(${p.value})`,transformOrigin:"0 0",width:`${b.value.width}px`,height:`${b.value.height}px`}),onDragover:t[1]||(t[1]=E(()=>{},["prevent"])),onDrop:_e,onMousedown:Ee,onMouseup:Pe,onContextmenu:t[2]||(t[2]=E(()=>{},["prevent"]))},[(m(!0),x(Z,null,Q(U.value,o=>(m(),x("div",{key:o.id,style:B({position:"absolute",left:o.left+"px",top:o.top+"px",width:o.width+"px",height:o.height+"px",background:o.color,zIndex:40}),class:"alignment-guide"},null,4))),128)),(m(),x("svg",{class:"connections-container",width:b.value.width,height:b.value.height},[g("g",null,[(m(!0),x(Z,null,Q(z.value,o=>(m(),x("path",{key:o.id,d:Re(o),"stroke-width":(w.value===o.id,5),stroke:w.value===o.id?"#000":"#3b82f6",fill:"none",class:"connection-line",onClick:E(c=>Ve(o.id),["stop"]),style:{cursor:"pointer"}},null,8,nt))),128))]),y.value?(m(),x("path",{key:0,d:Oe(),stroke:"#666","stroke-width":"2","stroke-dasharray":"5,5",fill:"none"},null,8,ot)):R("",!0)],8,lt)),(m(!0),x(Z,null,Q(f.value,o=>(m(),x("div",{key:o.id,class:Ge(["flow-node",{selected:r.value.includes(o.id),dragging:O.value.includes(o.id),resizing:M.value,"connection-source":y.value&&D.value===o.id}]),style:B({left:`${o.x}px`,top:`${o.y}px`,width:`${o.width}px`,height:`${o.height}px`,backgroundColor:o.color,borderRadius:o.type==="start"?"50%":"4px"}),onMousedown:[E(c=>$e(c,o),["stop"]),E(c=>Ke(o),["right","prevent"])],onClick:E(c=>ke(c,o),["stop"])},[g("div",st,re(o.label),1),r.value.includes(o.id)?(m(),x("div",ut,[g("div",{class:"resize-handle resize-handle-se",onMousedown:E(c=>G(c,o,"se"),["stop"])},null,40,ct),g("div",{class:"resize-handle resize-handle-sw",onMousedown:E(c=>G(c,o,"sw"),["stop"])},null,40,rt),g("div",{class:"resize-handle resize-handle-ne",onMousedown:E(c=>G(c,o,"ne"),["stop"])},null,40,ht),g("div",{class:"resize-handle resize-handle-nw",onMousedown:E(c=>G(c,o,"nw"),["stop"])},null,40,vt)])):R("",!0)],46,it))),128)),h.value.show?(m(),x("div",{key:0,class:"selection-box-area",style:B({"--box-x":`${P.value.x}px`,"--box-y":`${P.value.y}px`,"--box-width":`${P.value.width}px`,"--box-height":`${P.value.height}px`})},null,4)):R("",!0)],36)],4),g("div",dt,[r.value.length===1?(m(),he(s,{key:0,modelValue:q.value.label,"onUpdate:modelValue":t[3]||(t[3]=o=>q.value.label=o),placeholder:"节点名称"},null,8,["modelValue"])):R("",!0),w.value?(m(),x("div",pt,[t[5]||(t[5]=g("p",null,"已选中一条连线",-1)),S(n,{type:"danger",size:"small",onClick:ye},{default:N(()=>t[4]||(t[4]=[Ze("删除连线",-1)])),_:1,__:[4]})])):R("",!0)])],32)}}},ft=We(mt,[["__scopeId","data-v-78493dbe"]]),xt={__name:"HomeView",setup(H){const j=u([{type:"start",label:"",width:20,height:20,color:"green"},{type:"rect",label:"",width:20,height:20,color:"#f0f0f0"}]);return(de,f)=>(m(),he(ft,{bg:ve(Qe),isConnectionType:!0,"node-types":j.value},null,8,["bg","node-types"]))}};export{xt as default};
